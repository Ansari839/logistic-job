generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  OPERATOR
  ACCOUNTS
  SALES
}

enum JobType {
  IMPORT
  EXPORT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum InvoiceType {
  MASTER
  PROFORMA
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum TransactionType {
  JOURNAL
  RECEIPT
  PAYMENT
  INVOICE
  PURCHASE
}

enum PaymentMode {
  CASH
  BANK
  CHEQUE
  ONLINE
}

model Company {
  id             Int             @id @default(autoincrement())
  name           String
  uniqueId       String          @unique // For multi-tenant mapping
  address        String?
  phone          String?
  email          String?
  industry       String?
  logo           String?
  themeConfig    Json?           // { primaryColor: string, darkMode: boolean, etc. }
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  users          User[]
  branches       Branch[]
  currencies     CompanyCurrency[]
  taxSettings    TaxSetting[]
  systemSettings SystemSetting[]
  customers      Customer[]
  vendors        Vendor[]
  jobs           Job[]
  expenses       Expense[]
  invoices       Invoice[]
  accounts       Account[]
  transactions   Transaction[]
  payments       Payment[]
  
  // Animal Feed Module
  productCategories ProductCategory[]
  products          Product[]
  warehouses        Warehouse[]
  stockMovements    StockMovement[]
  purchaseInvoices  PurchaseInvoice[]
  auditLogs         AuditLog[]
  financialPeriods  FinancialPeriod[]
  expensesMaster    ExpenseMaster[]
  ports             Port[]
}

model Branch {
  id          Int          @id @default(autoincrement())
  name        String
  location    String?
  companyId   Int
  company     Company      @relation(fields: [companyId], references: [id])
  taxSettings TaxSetting[]
  jobs        Job[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Currency {
  id        Int               @id @default(autoincrement())
  code      String            @unique // PKR, USD, EUR
  symbol    String
  name      String
  companies CompanyCurrency[]
}

model CompanyCurrency {
  id           Int      @id @default(autoincrement())
  companyId    Int
  currencyId   Int
  exchangeRate Float    @default(1.0)
  isDefault    Boolean  @default(false)
  company      Company  @relation(fields: [companyId], references: [id])
  currency     Currency @relation(fields: [currencyId], references: [id])

  @@unique([companyId, currencyId])
}

model TaxSetting {
  id         Int      @id @default(autoincrement())
  name       String   // Sales Tax, WHT
  percentage Float
  type       String   // SALES, WHT
  companyId  Int
  branchId   Int?
  company    Company  @relation(fields: [companyId], references: [id])
  branch     Branch?  @relation(fields: [branchId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String   // timezone, language, dateFormat, numberFormat, featureFlags
  value     String
  type      String   // FLAG, FORMAT, CONFIG
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, key])
}

model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  name             String?
  password         String
  role             Role      @default(OPERATOR)
  companyId        Int?
  company          Company?  @relation(fields: [companyId], references: [id])
  branch           String?
  department       String?
  region           String?
  division         String?   @default("logistics")
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  auditLogs        AuditLog[]
}

model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  code      String    @unique
  address   String?
  phone     String?
  email     String?
  taxNumber String?   // NTN
  
  accountId Int?      @unique // Linked ledger account (Accounts Receivable)
  account   Account?  @relation(fields: [accountId], references: [id])
  
  companyId Int
  company   Company   @relation(fields: [companyId], references: [id])
  division  String?   @default("logistics")
  jobs      Job[]
  invoices  Invoice[]
  payments  Payment[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Vendor {
  id        Int       @id @default(autoincrement())
  name      String
  code      String    @unique
  type      String?   // TRANSPORT, PORT, CLEARING
  address   String?
  phone     String?
  email     String?
  taxNumber String?   // NTN
  
  accountId Int?      @unique // Linked ledger account (Accounts Payable)
  account   Account?  @relation(fields: [accountId], references: [id])
  
  companyId Int
  company   Company   @relation(fields: [companyId], references: [id])
  division  String?   @default("logistics")
  expenses  Expense[]
  payments  Payment[]
  purchaseInvoices PurchaseInvoice[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum JobStatus {
  DRAFT
  IN_PROGRESS
  CLOSED
}

model Job {
  id             Int       @id @default(autoincrement())
  jobNumber      String    @unique
  date           DateTime  @default(now())
  jobDate        DateTime  @default(now()) // Manual date from UI
  jobType        JobType   @default(EXPORT)
  status         JobStatus @default(DRAFT)
  
  customerId     Int
  customer       Customer  @relation(fields: [customerId], references: [id])
  
  vessel         String?
  place          String?
  shipperRef     String?
  gdNo           String?
  gdDate         DateTime?
  formE          String?
  formEDate      DateTime?
  commodity      String?
  volume         String?
  containerNo    String?
  
  podId          Int?
  pod            Port?     @relation(fields: [podId], references: [id])
  
  packages       Int?
  weight         Float?
  hawbBl         String?
  handledBy      String?
  salesPerson    String?
  
  companyId      Int
  company        Company   @relation(fields: [companyId], references: [id])
  division       String?   @default("logistics")
  branchId       Int?
  branch         Branch?   @relation(fields: [branchId], references: [id])
  
  expenses       Expense[]
  invoice        Invoice?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
}

model ExpenseMaster {
  id          Int      @id @default(autoincrement())
  code        String
  name        String
  companyId   Int
  company     Company  @relation(fields: [companyId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, code])
}

model Expense {
  id           Int      @id @default(autoincrement())
  jobId        Int
  job          Job      @relation(fields: [jobId], references: [id])
  
  vendorId     Int?
  vendor       Vendor?  @relation(fields: [vendorId], references: [id])
  
  description  String
  costPrice    Float    @default(0.0)
  sellingPrice Float    @default(0.0)
  currencyCode String   @default("PKR")
  exchangeRate Float    @default(1.0)
  
  companyId    Int
  company      Company  @relation(fields: [companyId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Invoice {
  id            Int           @id @default(autoincrement())
  invoiceNumber String
  date          DateTime      @default(now())
  
  jobId         Int           @unique
  job           Job           @relation(fields: [jobId], references: [id])
  
  customerId    Int
  customer      Customer      @relation(fields: [customerId], references: [id])
  
  type          InvoiceType   @default(MASTER)
  status        InvoiceStatus @default(DRAFT)
  
  // COT Fields
  masterNumber  String?
  agentCode     String?
  shippingLine  String?
  origin        String?
  destination   String?
  creditDays    Int?
  vendorType    String?
  
  totalAmount   Float         @default(0.0)
  taxAmount     Float         @default(0.0)
  grandTotal    Float         @default(0.0)
  currencyCode  String        @default("PKR")
  exchangeRate  Float         @default(1.0)
  
  isApproved    Boolean       @default(false)
  approvedById  Int?
  isLocked      Boolean       @default(false)
  lockedAt      DateTime?
  
  companyId     Int
  company       Company       @relation(fields: [companyId], references: [id])
  division      String?       @default("logistics")
  
  items         InvoiceItem[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Account mapping
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])
  transactionId Int?          @unique
  
  @@unique([companyId, invoiceNumber])
}

model InvoiceItem {
  id            Int     @id @default(autoincrement())
  invoiceId     Int
  invoice       Invoice @relation(fields: [invoiceId], references: [id])
  
  description   String
  quantity      Float   @default(1.0)
  rate          Float   @default(0.0)
  amount        Float
  taxPercentage Float   @default(0.0)
  taxAmount     Float   @default(0.0)
  total         Float
  
  productId     Int?
  product       Product?  @relation(fields: [productId], references: [id])
}

model ProductCategory {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  companyId   Int
  company     Company   @relation(fields: [companyId], references: [id])
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([companyId, name])
}

model Product {
  id            Int             @id @default(autoincrement())
  sku           String?         @unique
  name          String
  description   String?
  unit          String          @default("unit")
  purchasePrice Float           @default(0.0)
  sellingPrice  Float           @default(0.0)
  
  categoryId    Int
  category      ProductCategory @relation(fields: [categoryId], references: [id])
  
  companyId     Int
  company       Company         @relation(fields: [companyId], references: [id])
  
  movements     StockMovement[]
  invoiceItems  InvoiceItem[]
  purchaseItems PurchaseInvoiceItem[]

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?

  @@unique([companyId, name])
}

model Warehouse {
  id            Int             @id @default(autoincrement())
  name          String
  location      String?
  companyId     Int
  company       Company         @relation(fields: [companyId], references: [id])
  stockMovements StockMovement[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([companyId, name])
}

model StockMovement {
  id            Int       @id @default(autoincrement())
  productId     Int
  product       Product   @relation(fields: [productId], references: [id])
  
  warehouseId   Int?
  warehouse     Warehouse? @relation(fields: [warehouseId], references: [id])
  
  quantity      Float     // Positive for In, Negative for Out
  type          String    // PURCHASE, SALE, ADJUSTMENT, TRANSFER
  reference     String?   // Invoice number or Purchase number
  
  companyId     Int
  company       Company   @relation(fields: [companyId], references: [id])
  
  createdAt     DateTime  @default(now())
}

model PurchaseInvoice {
  id            Int           @id @default(autoincrement())
  purchaseNumber String       @unique // PUR-001
  date          DateTime      @default(now())
  
  vendorId      Int
  vendor        Vendor        @relation(fields: [vendorId], references: [id])
  
  status        InvoiceStatus @default(DRAFT)
  
  totalAmount   Float         @default(0.0)
  taxAmount     Float         @default(0.0)
  grandTotal    Float         @default(0.0)
  currencyCode  String        @default("PKR")
  
  isApproved    Boolean       @default(false)
  approvedById  Int?
  isLocked      Boolean       @default(false)
  lockedAt      DateTime?
  
  companyId     Int
  company       Company       @relation(fields: [companyId], references: [id])
  
  items         PurchaseInvoiceItem[]
  
  transactionId Int?          @unique
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?
}

model PurchaseInvoiceItem {
  id                Int             @id @default(autoincrement())
  purchaseInvoiceId Int
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  
  productId         Int
  product           Product         @relation(fields: [productId], references: [id])
  
  description       String?
  quantity          Float
  rate              Float
  amount            Float
  taxPercentage     Float           @default(0.0)
  taxAmount         Float           @default(0.0)
  total             Float
}

model Account {
  id          Int           @id @default(autoincrement())
  code        String        // e.g., 1000, 1100
  name        String        // e.g., Cash, Accounts Receivable
  type        AccountType
  description String?
  
  parentId    Int?
  parent      Account?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]     @relation("AccountHierarchy")
  
  companyId   Int
  company     Company       @relation(fields: [companyId], references: [id])
  division    String?       @default("logistics")
  
  entries     AccountEntry[]
  
  customer    Customer?
  vendor      Vendor?
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([companyId, code])
}

model Transaction {
  id            Int             @id @default(autoincrement())
  reference     String          // JV-001, INV-001, PAY-001
  date          DateTime        @default(now())
  description   String?
  type          TransactionType @default(JOURNAL)
  
  entries       AccountEntry[]
  
  invoice       Invoice?
  payment       Payment?
  purchase      PurchaseInvoice?
  
  companyId     Int
  company       Company         @relation(fields: [companyId], references: [id])
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  isLocked      Boolean         @default(false)

  @@unique([companyId, reference])
}

model AccountEntry {
  id            Int         @id @default(autoincrement())
  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  accountId     Int
  account       Account     @relation(fields: [accountId], references: [id])
  
  description   String?
  debit         Float       @default(0.0)
  credit        Float       @default(0.0)
  
  createdAt     DateTime    @default(now())
}

model Payment {
  id            Int         @id @default(autoincrement())
  receiptNumber String      // REC-001, PAY-001
  date          DateTime    @default(now())
  
  amount        Float
  mode          PaymentMode @default(CASH)
  reference     String?     // Cheque no, Online ref
  
  customerId    Int?
  customer      Customer?   @relation(fields: [customerId], references: [id])
  
  vendorId      Int?
  vendor        Vendor?     @relation(fields: [vendorId], references: [id])
  
  transactionId Int         @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  companyId     Int
  company       Company     @relation(fields: [companyId], references: [id])
  division      String?     @default("logistics")
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([companyId, receiptNumber])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  action    String   // CREATE, UPDATE, DELETE, APPROVE, LOCK
  module    String   // JOB, INVOICE, ACCOUNT, etc.
  entityId  Int?
  payload   Json?    // Before/After values or current state
  ipAddress String?
  createdAt DateTime @default(now())
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
}

model FinancialPeriod {
  id        Int      @id @default(autoincrement())
  month     Int      // 1-12
  year      Int
  isClosed  Boolean  @default(false)
  closedById Int?
  closedAt  DateTime?
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, month, year])
}
model Port {
  id        Int      @id @default(autoincrement())
  name      String
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  jobs      Job[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}
