generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                Int               @id @default(autoincrement())
  name              String
  uniqueId          String            @unique
  address           String?
  phone             String?
  email             String?
  industry          String?
  logo              String?
  themeConfig       Json?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  city              String?
  country           String?
  fiscalYearEnd     DateTime?
  fiscalYearStart   DateTime?
  postalCode        String?
  registrationNo    String?
  state             String?
  tagline           String?
  taxNumber         String?
  website           String?
  accounts          Account[]
  auditLogs         AuditLog[]
  branches          Branch[]
  currencies        CompanyCurrency[]
  customers         Customer[]
  expenses          Expense[]
  expensesMaster    ExpenseMaster[]
  financialPeriods  FinancialPeriod[]
  serviceInvoices   ServiceInvoice[]
  freightInvoices   FreightInvoice[]
  jobs              Job[]
  payments          Payment[]
  ports             Port[]
  products          Product[]
  productCategories ProductCategory[]
  purchaseInvoices  PurchaseInvoice[]
  stockMovements    StockMovement[]
  systemSettings    SystemSetting[]
  taxSettings       TaxSetting[]
  transactions      Transaction[]
  users             User[]
  vendors           Vendor[]
  vouchers          Voucher[]
  warehouses        Warehouse[]
}

model Branch {
  id          Int          @id @default(autoincrement())
  name        String
  location    String?
  companyId   Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  company     Company      @relation(fields: [companyId], references: [id])
  jobs        Job[]
  taxSettings TaxSetting[]
}

model Currency {
  id        Int               @id @default(autoincrement())
  code      String            @unique
  symbol    String
  name      String
  companies CompanyCurrency[]
}

model CompanyCurrency {
  id           Int      @id @default(autoincrement())
  companyId    Int
  currencyId   Int
  exchangeRate Float    @default(1.0)
  isDefault    Boolean  @default(false)
  company      Company  @relation(fields: [companyId], references: [id])
  currency     Currency @relation(fields: [currencyId], references: [id])

  @@unique([companyId, currencyId])
}

model TaxSetting {
  id         Int      @id @default(autoincrement())
  name       String
  percentage Float
  type       String
  companyId  Int
  branchId   Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  branch     Branch?  @relation(fields: [branchId], references: [id])
  company    Company  @relation(fields: [companyId], references: [id])
}

model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String
  value     String
  type      String
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, key])
}

model User {
  id               Int        @id @default(autoincrement())
  email            String     @unique
  name             String?
  password         String
  role             Role       @default(OPERATOR)
  companyId        Int?
  branch           String?
  department       String?
  region           String?
  division         String?    @default("logistics")
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  auditLogs        AuditLog[]
  company          Company?   @relation(fields: [companyId], references: [id])
  postedVouchers   Voucher[]  @relation("VoucherPoster")
}

model Customer {
  id              Int              @id @default(autoincrement())
  name            String
  code            String           @unique
  address         String?
  phone           String?
  email           String?
  taxNumber       String?
  accountId       Int?             @unique
  companyId       Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  division        String?          @default("logistics")
  account         Account?         @relation(fields: [accountId], references: [id])
  company         Company          @relation(fields: [companyId], references: [id])
  serviceInvoices ServiceInvoice[]
  freightInvoices FreightInvoice[]
  jobs            Job[]
  payments        Payment[]
}

model Vendor {
  id               Int                  @id @default(autoincrement())
  name             String
  code             String               @unique
  type             String?
  address          String?
  phone            String?
  email            String?
  taxNumber        String?
  accountId        Int?                 @unique
  companyId        Int
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  division         String?              @default("logistics")
  expenses         Expense[]
  payments         Payment[]
  purchaseInvoices PurchaseInvoice[]
  account          Account?             @relation(fields: [accountId], references: [id])
  company          Company              @relation(fields: [companyId], references: [id])
  freightItems     FreightInvoiceItem[]
}

model Job {
  id             Int             @id @default(autoincrement())
  jobNumber      String          @unique
  date           DateTime        @default(now())
  jobDate        DateTime        @default(now())
  jobType        JobType         @default(EXPORT)
  status         JobStatus       @default(DRAFT)
  customerId     Int
  vessel         String?
  place          String?
  shipperRef     String?
  gdNo           String?
  gdDate         DateTime?
  formE          String?
  formEDate      DateTime?
  commodity      String?
  volume         String?
  containerNo    String?
  podId          Int?
  packages       Int?
  weight         Float?
  hawbBl         String?
  handledBy      String?
  salesPerson    String?
  companyId      Int
  branchId       Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  division       String?         @default("logistics")
  expenses       Expense[]
  serviceInvoice ServiceInvoice?
  freightInvoice FreightInvoice?
  branch         Branch?         @relation(fields: [branchId], references: [id])
  company        Company         @relation(fields: [companyId], references: [id])
  customer       Customer        @relation(fields: [customerId], references: [id])
  pod            Port?           @relation(fields: [podId], references: [id])
}

model ExpenseMaster {
  id        Int      @id @default(autoincrement())
  code      String
  name      String
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, code])
}

model Expense {
  id           Int      @id @default(autoincrement())
  jobId        Int
  vendorId     Int?
  description  String
  costPrice    Float    @default(0.0)
  sellingPrice Float    @default(0.0)
  currencyCode String   @default("PKR")
  exchangeRate Float    @default(1.0)
  companyId    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company  @relation(fields: [companyId], references: [id])
  job          Job      @relation(fields: [jobId], references: [id])
  vendor       Vendor?  @relation(fields: [vendorId], references: [id])
}

model ServiceInvoice {
  id            Int                  @id @default(autoincrement())
  invoiceNumber String
  date          DateTime             @default(now())
  jobId         Int                  @unique
  customerId    Int
  type          InvoiceType          @default(MASTER)
  status        InvoiceStatus        @default(DRAFT)
  masterNumber  String?
  agentCode     String?
  shippingLine  String?
  origin        String?
  destination   String?
  creditDays    Int?
  vendorType    String?
  totalAmount   Float                @default(0.0)
  taxAmount     Float                @default(0.0)
  grandTotal    Float                @default(0.0)
  currencyCode  String               @default("PKR")
  exchangeRate  Float                @default(1.0)
  isApproved    Boolean              @default(false)
  approvedById  Int?
  isLocked      Boolean              @default(false)
  lockedAt      DateTime?
  companyId     Int
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  transactionId Int?                 @unique
  division      String?              @default("logistics")
  company       Company              @relation(fields: [companyId], references: [id])
  customer      Customer             @relation(fields: [customerId], references: [id])
  job           Job                  @relation(fields: [jobId], references: [id])
  transaction   Transaction?         @relation(fields: [transactionId], references: [id])
  items         ServiceInvoiceItem[]

  @@unique([companyId, invoiceNumber])
  @@map("Invoice")
}

model ServiceInvoiceItem {
  id            Int            @id @default(autoincrement())
  invoiceId     Int
  description   String
  quantity      Float          @default(1.0)
  rate          Float          @default(0.0)
  amount        Float
  taxPercentage Float          @default(0.0)
  taxAmount     Float          @default(0.0)
  total         Float
  productId     Int?
  invoice       ServiceInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product       Product?       @relation(fields: [productId], references: [id])

  @@map("InvoiceItem")
}

model FreightInvoice {
  id            Int                  @id @default(autoincrement())
  invoiceNumber String
  date          DateTime             @default(now())
  jobId         Int?                 @unique
  customerId    Int
  type          InvoiceType          @default(MASTER)
  status        InvoiceStatus        @default(DRAFT)
  usdRate       Float                @default(0.0)
  exchangeRate  Float                @default(1.0)
  totalAmount   Float                @default(0.0)
  taxAmount     Float                @default(0.0)
  grandTotal    Float                @default(0.0)
  currencyCode  String               @default("PKR")
  isApproved    Boolean              @default(false)
  approvedById  Int?
  isLocked      Boolean              @default(false)
  lockedAt      DateTime?
  companyId     Int
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  transactionId Int?                 @unique
  division      String?              @default("logistics")
  company       Company              @relation(fields: [companyId], references: [id])
  customer      Customer             @relation(fields: [customerId], references: [id])
  transaction   Transaction?         @relation(fields: [transactionId], references: [id])
  job           Job?                 @relation(fields: [jobId], references: [id])
  items         FreightInvoiceItem[]

  @@unique([companyId, invoiceNumber])
}

model FreightInvoiceItem {
  id            Int            @id @default(autoincrement())
  invoiceId     Int
  description   String
  quantity      Float          @default(1.0)
  rate          Float          @default(0.0)
  amount        Float
  taxPercentage Float          @default(0.0)
  taxAmount     Float          @default(0.0)
  total         Float
  vendorId      Int?
  invoice       FreightInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  vendor        Vendor?        @relation(fields: [vendorId], references: [id])
}

model ProductCategory {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  companyId   Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  company     Company   @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
}

model Product {
  id            Int                   @id @default(autoincrement())
  sku           String?               @unique
  name          String
  description   String?
  unit          String                @default("unit")
  purchasePrice Float                 @default(0.0)
  sellingPrice  Float                 @default(0.0)
  categoryId    Int
  companyId     Int
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  deletedAt     DateTime?
  serviceItems  ServiceInvoiceItem[]
  category      ProductCategory       @relation(fields: [categoryId], references: [id])
  company       Company               @relation(fields: [companyId], references: [id])
  purchaseItems PurchaseInvoiceItem[]
  movements     StockMovement[]

  @@unique([companyId, name])
}

model Warehouse {
  id             Int             @id @default(autoincrement())
  name           String
  location       String?
  companyId      Int
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stockMovements StockMovement[]
  company        Company         @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
}

model StockMovement {
  id          Int        @id @default(autoincrement())
  productId   Int
  warehouseId Int?
  quantity    Float
  type        String
  reference   String?
  companyId   Int
  createdAt   DateTime   @default(now())
  company     Company    @relation(fields: [companyId], references: [id])
  product     Product    @relation(fields: [productId], references: [id])
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])
}

model PurchaseInvoice {
  id             Int                   @id @default(autoincrement())
  purchaseNumber String                @unique
  date           DateTime              @default(now())
  vendorId       Int
  status         InvoiceStatus         @default(DRAFT)
  totalAmount    Float                 @default(0.0)
  taxAmount      Float                 @default(0.0)
  grandTotal     Float                 @default(0.0)
  currencyCode   String                @default("PKR")
  isApproved     Boolean               @default(false)
  approvedById   Int?
  isLocked       Boolean               @default(false)
  lockedAt       DateTime?
  companyId      Int
  transactionId  Int?                  @unique
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  deletedAt      DateTime?
  company        Company               @relation(fields: [companyId], references: [id])
  transaction    Transaction?          @relation(fields: [transactionId], references: [id])
  vendor         Vendor                @relation(fields: [vendorId], references: [id])
  items          PurchaseInvoiceItem[]
}

model PurchaseInvoiceItem {
  id                Int             @id @default(autoincrement())
  purchaseInvoiceId Int
  productId         Int
  description       String?
  quantity          Float
  rate              Float
  amount            Float
  taxPercentage     Float           @default(0.0)
  taxAmount         Float           @default(0.0)
  total             Float
  product           Product         @relation(fields: [productId], references: [id])
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
}

model Account {
  id             Int            @id @default(autoincrement())
  code           String
  name           String
  type           AccountType
  description    String?
  parentId       Int?
  companyId      Int
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  division       String?        @default("logistics")
  company        Company        @relation(fields: [companyId], references: [id])
  parent         Account?       @relation("AccountHierarchy", fields: [parentId], references: [id])
  children       Account[]      @relation("AccountHierarchy")
  entries        AccountEntry[]
  customer       Customer?
  vendor         Vendor?
  voucherEntries VoucherEntry[]

  @@unique([companyId, code])
}

model Transaction {
  id          Int              @id @default(autoincrement())
  reference   String
  date        DateTime         @default(now())
  description String?
  type        TransactionType  @default(JOURNAL)
  companyId   Int
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  isLocked    Boolean          @default(false)
  entries     AccountEntry[]
  service     ServiceInvoice?
  freight     FreightInvoice?
  payment     Payment?
  purchase    PurchaseInvoice?
  company     Company          @relation(fields: [companyId], references: [id])

  @@unique([companyId, reference])
}

model AccountEntry {
  id            Int         @id @default(autoincrement())
  transactionId Int
  accountId     Int
  description   String?
  debit         Float       @default(0.0)
  credit        Float       @default(0.0)
  createdAt     DateTime    @default(now())
  account       Account     @relation(fields: [accountId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model Payment {
  id            Int         @id @default(autoincrement())
  receiptNumber String
  date          DateTime    @default(now())
  amount        Float
  mode          PaymentMode @default(CASH)
  reference     String?
  customerId    Int?
  vendorId      Int?
  transactionId Int         @unique
  companyId     Int
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  division      String?     @default("logistics")
  company       Company     @relation(fields: [companyId], references: [id])
  customer      Customer?   @relation(fields: [customerId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  vendor        Vendor?     @relation(fields: [vendorId], references: [id])

  @@unique([companyId, receiptNumber])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  module    String
  entityId  Int?
  payload   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model FinancialPeriod {
  id         Int       @id @default(autoincrement())
  month      Int
  year       Int
  isClosed   Boolean   @default(false)
  closedById Int?
  closedAt   DateTime?
  companyId  Int
  company    Company   @relation(fields: [companyId], references: [id])

  @@unique([companyId, month, year])
}

model Port {
  id        Int      @id @default(autoincrement())
  name      String
  companyId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobs      Job[]
  company   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
}

model Voucher {
  id            Int           @id @default(autoincrement())
  voucherNumber String
  voucherType   VoucherType
  status        VoucherStatus @default(DRAFT)
  date          DateTime      @default(now())
  postingDate   DateTime?

  // Instrument Details (for Bank/Cheque)
  paymentMode    PaymentMode?
  instrumentNo   String?
  instrumentDate DateTime?
  bankName       String?

  narration  String?
  companyId  Int
  division   String?        @default("logistics")
  isPosted   Boolean        @default(false)
  postedAt   DateTime?
  postedById Int?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  company    Company        @relation(fields: [companyId], references: [id])
  postedBy   User?          @relation("VoucherPoster", fields: [postedById], references: [id])
  entries    VoucherEntry[]

  @@unique([companyId, voucherNumber])
  @@index([companyId])
  @@index([voucherNumber])
}

model VoucherEntry {
  id          Int      @id @default(autoincrement())
  voucherId   Int
  accountId   Int
  debit       Float    @default(0)
  credit      Float    @default(0)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  account     Account  @relation(fields: [accountId], references: [id])
  voucher     Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  OPERATOR
  ACCOUNTS
  SALES
}

enum JobType {
  IMPORT
  EXPORT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum InvoiceType {
  MASTER
  PROFORMA
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum VoucherType {
  PAYMENT
  RECEIPT
  JOURNAL
  CONTRA
}

enum VoucherStatus {
  DRAFT
  POSTED
  CANCELLED
}

enum TransactionType {
  JOURNAL
  RECEIPT
  PAYMENT
  CONTRA
  INVOICE
  PURCHASE
}

enum PaymentMode {
  CASH
  BANK
  CHEQUE
  ONLINE
}

enum JobStatus {
  DRAFT
  IN_PROGRESS
  CLOSED
}
